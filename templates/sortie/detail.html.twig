{% extends 'base.html.twig' %}

{% block title %}Afficher une sortie{% endblock %}

{% block stylesheets %}
    <style>
        section {
            padding:20px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
{% endblock %}

{% block body %}
  <main class="container">
    <h1 class="page-title">Afficher une sortie</h1>

    {% if app.user
    and sortie.etat.libelle == 'En création'
    and (
        sortie.organisateurSortie.id == app.user.id
        or app.user.isAdmin()
    )
%}
    <a class="btn btn-warning" href="{{ path('sortie_modifier', {id: sortie.id}) }}">
        Modifier
    </a>

{% endif %}


    <section class="card sortie-detail">
      <div class="sortie-detail__cols">
        <div class="sortie-detail__col">
          <div class="row">
            <div class="label">Nom de la sortie</div>
            <div class="value">{{ sortie.name ?? '—' }}</div>
          </div>

          <div class="row">
            <div class="label">Date et heure de la sortie</div>
            <div class="value">
              {{ sortie.dateHeureDebut ? sortie.dateHeureDebut|date('d/m/Y H:i') : '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Date limite d'inscription</div>
            <div class="value">
              {{ sortie.dateLimiteInscription ? sortie.dateLimiteInscription|date('d/m/Y') : '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Nombre de places</div>
            <div class="value">{{ sortie.nbInscriptionMax ?? '—' }}</div>
          </div>

          <div class="row">
            <div class="label">Durée</div>
            <div class="value">
              {# duree est un TIME (DateTime) #}
              {{ sortie.duree ? sortie.duree|date('H:i') : '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Organisateur</div>
            <div class="value">
              {% if sortie.organisateurSortie %}
                <a href="{{ path('participant_show', {id: sortie.organisateurSortie.id}) }}">
                  {{ (sortie.organisateurSortie.firstname ~ ' ' ~ sortie.organisateurSortie.name)|trim ?: sortie.organisateurSortie.email }}
                </a>
              {% else %}
                —
              {% endif %}
            </div>
          </div>
        </div>

        <div class="sortie-detail__col">
          <div class="row">
            <div class="label">Campus</div>
            <div class="value">
              {# adapte nom/name si besoin dans Campus #}
              {{ sortie.campus.name ?? sortie.campus.nom ?? '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Ville</div>
            <div class="value">
              {# adapte name/nom + le chemin selon Lieu -> Ville #}
              {{ sortie.lieu.ville.name ?? sortie.lieu.ville.nom ?? '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Lieu</div>
            <div class="value">
              {{ sortie.lieu.name ?? sortie.lieu.nom ?? '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Rue</div>
            <div class="value">
              {{ sortie.lieu.street ?? sortie.lieu.rue ?? '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Code postal</div>
            <div class="value">
              {{ sortie.lieu.ville.codePostal ?? sortie.lieu.codePostal ?? '—' }}
            </div>
          </div>

          <div class="row">
            <div class="label">Latitude / Longitude</div>
            <div class="value">
              {# ici adapte selon ta typo latitute / longitute dans Lieu #}
              {{ sortie.lieu.latitute ?? sortie.lieu.latitude ?? '—' }} /
              {{ sortie.lieu.longitute ?? sortie.lieu.longitude ?? '—' }}
            </div>
          </div>
        </div>
      </div>

      <div class="row row--wide">
        <div class="label">Description et infos</div>
        <div class="value">{{ sortie.infoSortie ?? '—' }}</div>
      </div>

      {% if sortie.etat.libelle == 'Annulée' %}
        <div class="alert alert-warning mt-3">
            <strong>Motif d'annulation</strong><br>
            {{ sortie.motifAnnulation }}

        </div>

      {% endif %}

      <div class="bottom-area">
        <section class="participants-box" aria-label="Liste des participants inscrits">
          <h2 class="participants-box__title">
            Liste des participants inscrits
            <small>({{ sortie.participants|length }})</small>
          </h2>

          <table class="table table--mini">
            <thead>
            <tr>
              <th scope="col">Email</th>
              <th scope="col">Nom</th>
            </tr>
            </thead>
            <tbody>
            {% for p in sortie.participants %}
              <tr>
                <td>
                  <a href="{{ path('participant_show', {id: p.id}) }}">{{ p.email }}</a>
                </td>
                <td>{{ (p.firstname ~ ' ' ~ p.name)|trim ?: '—' }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="2">Aucun participant</td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </section>
      </div>
        {% if sortie.lieu.latitude != null and sortie.lieu.longitude != null %}
            <div id="map" style="height: 300px;"></div>
        {% endif %}
    </section>


  </main>
    {% block javascripts %}
    <script>
        var latitude = "{{ sortie.lieu.latitude }}"
        var longitude = "{{ sortie.lieu.longitude }}"
        var map = L.map('map').setView([latitude, longitude], 13);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        var marker = L.marker([latitude, longitude]).addTo(map);
    </script>
        {% endblock %}
{% endblock %}
