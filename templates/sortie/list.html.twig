{% extends 'base.html.twig' %}

{% block title %}Sortir - Accueil{% endblock %}

{% block body %}
  <main class="container">

    <section class="filters card">
      <h2>Filtrer les sorties</h2>

      <div class="well">
        <form method="get" action="{{ path('sortie_list') }}">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="campus">Campus</label>
                <select id="campus" name="campus" class="form-control">
                  <option value="">-- Tous --</option>
                  {% for c in campusOptions %}
                    <option value="{{ c.id }}" {% if filters.campus == c.id %}selected{% endif %}>
                      {{ c.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group mt-2">
                <label for="ville">Ville</label>
                <select id="ville" name="ville" class="form-control">
                  <option value="">-- Toutes --</option>
                  {% for v in villeOptions %}
                    <option value="{{ v.id }}" {% if filters.ville == v.id %}selected{% endif %}>
                      {{ v.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group mt-2">
                <label for="q">Le nom de la sortie contient :</label>
                <input type="text" id="q" name="q" value="{{ filters.q }}" class="form-control" placeholder="search">
              </div>
            </div>

            <div class="col-md-6">
              <div class="row">
                <div class="col-md-6">
                  <label for="from">Entre :</label>
                  <input type="date" id="from" name="from" value="{{ filters.from }}" class="form-control">
                </div>
                <div class="col-md-6">
                  <label for="to">Et :</label>
                  <input type="date" id="to" name="to" value="{{ filters.to }}" class="form-control">
                </div>
              </div>

              <div class="mt-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mine" name="mine" value="1" {% if filters.mine %}checked{% endif %}>
                  <label class="form-check-label" for="mine">Sorties dont je suis l'organisateur/trice</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="registered" name="registered" value="1" {% if filters.registered %}checked{% endif %}>
                  <label class="form-check-label" for="registered">Sorties auxquelles je suis inscrit/e</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="not_registered" name="not_registered" value="1" {% if filters.not_registered %}checked{% endif %}>
                  <label class="form-check-label" for="not_registered">Sorties auxquelles je ne suis pas inscrit/e</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="finished" name="finished" value="1" {% if filters.finished %}checked{% endif %}>
                  <label class="form-check-label" for="finished">Sorties passées</label>
                </div>
              </div>
            </div>
          </div>

          <div class="row mt-3">
            <div class="col-md-12 text-center">
              <button type="submit" class="btn btn-primary btn-lg">Rechercher</button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>Nom de la sortie</th>
            <th>Date de la sortie</th>
            <th>Clôture</th>
            <th>Inscrits/Places</th>
            <th>État</th>
            <th>Inscrit</th>
            <th>Organisateur</th>
            <th>Actions</th>
          </tr>
          </thead>

          <tbody>
          {% for s in sorties %}
            {% set isIn = app.user and (app.user in s.participants) %}

            {% set etat = s.etat.libelle %}

            {% set isFull = s.participants|length >= s.nbInscriptionMax %}
            {% set isOrganisateur = app.user and s.organisateurSortie and (app.user.id == s.organisateurSortie.id) %}
            {% set canPublish = isOrganisateur or (app.user and app.user.isAdmin) %}

            <tr>
              <td>
                <a href="{{ path('sortie_detail', {id: s.id}) }}">
                  {{ s.name }}
                </a>
              </td>
              <td>{{ s.dateHeureDebut ? s.dateHeureDebut|date('d/m/Y H:i') : '' }}</td>
              <td>{{ s.dateLimiteInscription ? s.dateLimiteInscription|date('d/m/Y') : '' }}</td>
              <td>{{ s.participants|length }}/{{ s.nbInscriptionMax }}</td>


              <td>{{ s.etat.libelle }}</td>

              <td class="center">{{ isIn ? 'X' : '' }}</td>

              <td>
                {% if s.organisateurSortie %}
                  <a href="{{ path('participant_show', {id: s.organisateurSortie.id}) }}">
                    {{ s.organisateurSortie.name ?? s.organisateurSortie.name ?? 'Organisateur' }}
                  </a>
                {% endif %}
              </td>
                <td>
                    {% set participants = s.participants.toArray %}
                    {% for p in participants %}
                        <a href="{{ path('participant_show', {id: p.id}) }}">{{ p.username }}</a>
                    {% endfor %}
                </td>


              <td>


                {% if app.user %}

                  {% if etat == 'En création' and canPublish %}
                    <a class="action-link" href="{{ path('sortie_publier', {id: s.id}) }}">Publier</a>
                  {% endif %}

                  {% set isOrganisateur = app.user and s.organisateurSortie and s.organisateurSortie.id == app.user.id %}
                  {% set isAdmin = app.user and 'ROLE_ADMIN' in app.user.roles %}

                  {% if s.etat.libelle == 'En création' and (isOrganisateur or isAdmin) %}
                    <a href="{{ path('sortie_modifier', { id: s.id }) }}"
                       class="btn btn-sm btn-warning">
                      Modifier
                    </a>
                  {% endif %}

                  {% if etat == 'Ouverte' %}
                    {% if isIn %}
                      <a class="action-link" href="{{ path('sortie_desister', {id: s.id}) }}">Se désister</a>
                    {% elseif not isFull %}
                      <a class="action-link" href="{{ path('sortie_inscrire', {id: s.id}) }}">S'inscrire</a>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% set etat = s.etat.libelle %}
                {% set isOrganisateur = app.user and s.organisateurSortie and (app.user.id == s.organisateurSortie.id) %}
                {% set canManage = isOrganisateur or (app.user and app.user.isAdmin) %}


                {% set othersCount = 0 %}
                {% for p in s.participants %}
                  {% if s.organisateurSortie and p.id != s.organisateurSortie.id %}
                    {% set othersCount = othersCount + 1 %}
                  {% endif %}
                {% endfor %}

                {# ... #}

                {% if app.user and canManage and etat == 'Ouverte' and etat != 'En cours' %}
                  <button
                    class="action-link btn btn-link text-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#annulerSortieModal-{{ s.id }}">
                    Annuler
              </button>


                  <div class="modal fade" id="annulerSortieModal-{{ s.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">

                        <form method="post" action="{{ path('sortie_annuler', {id: s.id}) }}">
                          <div class="modal-header">
                            <h5 class="modal-title">Annuler la sortie</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>

                          <div class="modal-body">
                            <label class="form-label">Motif d’annulation</label>
                            <textarea name="motif" class="form-control" required></textarea>
                          </div>

                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Retour</button>
                            <button type="submit" class="btn btn-danger">Confirmer</button>
                          </div>
                        </form>

                      </div>
                    </div>


                {% endif %}

              <div class="modal fade" id="annulerSortieModal-{{ s.id }}" tabindex="-1" aria-hidden="true">
              </div>
              </td>

            </tr>
          {% else %}
            <tr>
              <td colspan="8" class="center">Aucune sortie trouvée.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>


         {% if app.user %}
              <div class="create-sortie" style="text-align: center">
                  <a class="btn btn-secondary" href="{{ path('sortie_create') }}" style="margin-bottom: 15px">Créer une sortie</a>
              </div>
         {% endif %}
    </section>
  </main>
{% endblock %}
