{% extends 'base.html.twig' %}

{% block title %}Sortir - Accueil{% endblock %}

{% block body %}
  <main class="container">

    <section class="filters card">
      <h2>Filtrer les sorties</h2>

      <form method="get" class="filters-layout">
        <div class="filters-left">
          <div class="row">
            <label for="campus">Campus</label>
            <select id="campus" name="campus">
              <option value="">-- Tous --</option>
              {% for c in campusOptions %}
                <option value="{{ c.id }}" {% if filters.campus == (c.id ~ '') %}selected{% endif %}>
                  {{ c.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <label for="q">Le nom de la sortie contient</label>
            <input id="q" name="q" type="search" value="{{ filters.q }}" placeholder="search">
          </div>

          <div class="row row-inline">
            <label for="from">Entre</label>
            <input id="from" name="from" type="date" value="{{ filters.from }}">
            <span class="inline-text">et</span>
            <input id="to" name="to" type="date" value="{{ filters.to }}">
          </div>
        </div>

        <div class="filters-middle">
          <label class="check">
            <input type="checkbox" name="mine" {% if filters.mine %}checked{% endif %}>
            Sorties dont je suis l'organisateur/trice
          </label>

          <label class="check">
            <input type="checkbox" name="registered" {% if filters.registered %}checked{% endif %}>
            Sorties auxquelles je suis inscrit/e
          </label>

          <label class="check">
            <input type="checkbox" name="not_registered" {% if filters.not_registered %}checked{% endif %}>
            Sorties auxquelles je ne suis pas inscrit/e
          </label>

          <label class="check">
            <input type="checkbox" name="finished" {% if filters.finished %}checked{% endif %}>
            Sorties terminées
          </label>
        </div>

        <div class="filters-right">
          <button class="btn btn--big" type="submit">Rechercher</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table class="table">
          <thead>
          <tr>
            <th>Nom de la sortie</th>
            <th>Date de la sortie</th>
            <th>Clôture</th>
            <th>Inscrits/Places</th>
            <th>État</th>
            <th>Inscrit</th>
            <th>Organisateur</th>
            <th>Actions</th>
          </tr>
          </thead>

          <tbody>
          {% for s in sorties %}
            {% set isIn = app.user and (app.user in s.participants) %}

            {% set etat = s.etat.libelle %}

            {% set isFull = s.participants|length >= s.nbInscriptionMax %}
            {% set isOrganisateur = app.user and s.organisateurSortie and (app.user.id == s.organisateurSortie.id) %}
            {% set canPublish = isOrganisateur or (app.user and app.user.isAdmin) %}

            <tr>
              <td>
                <a href="{{ path('sortie_detail', {id: s.id}) }}">
                  {{ s.name }}
                </a>
              </td>
              <td>{{ s.dateHeureDebut ? s.dateHeureDebut|date('d/m/Y H:i') : '' }}</td>
              <td>{{ s.dateLimiteInscription ? s.dateLimiteInscription|date('d/m/Y') : '' }}</td>
              <td>{{ s.participants|length }}/{{ s.nbInscriptionMax }}</td>


              <td>{{ s.etat.libelle }}</td>

              <td class="center">{{ isIn ? 'X' : '' }}</td>

              <td>
                {% if s.organisateurSortie %}
                  <a href="{{ path('participant_show', {id: s.organisateurSortie.id}) }}">
                    {{ s.organisateurSortie.name ?? s.organisateurSortie.name ?? 'Organisateur' }}
                  </a>
                {% endif %}
              </td>
                <td>
                    {% set participants = s.participants.toArray %}
                    {% for p in participants %}
                        <a href="{{ path('participant_show', {id: p.id}) }}">{{ p.username }}</a>
                    {% endfor %}
                </td>


              <td>


                {% if app.user %}

                  {% if etat == 'En création' and canPublish %}
                    <a class="action-link" href="{{ path('sortie_publier', {id: s.id}) }}">Publier</a>
                  {% endif %}

                  {% set isOrganisateur = app.user and s.organisateurSortie and s.organisateurSortie.id == app.user.id %}
                  {% set isAdmin = app.user and 'ROLE_ADMIN' in app.user.roles %}

                  {% if s.etat.libelle == 'En création' and (isOrganisateur or isAdmin) %}
                    <a href="{{ path('sortie_modifier', { id: s.id }) }}"
                       class="btn btn-sm btn-warning">
                      Modifier
                    </a>
                  {% endif %}

                  {% if etat == 'Ouverte' %}
                    {% if isIn %}
                      <a class="action-link" href="{{ path('sortie_desister', {id: s.id}) }}">Se désister</a>
                    {% elseif not isFull %}
                      <a class="action-link" href="{{ path('sortie_inscrire', {id: s.id}) }}">S'inscrire</a>
                    {% endif %}
                  {% endif %}
                {% endif %}
                {% set etat = s.etat.libelle %}
                {% set isOrganisateur = app.user and s.organisateurSortie and (app.user.id == s.organisateurSortie.id) %}
                {% set canManage = isOrganisateur or (app.user and app.user.isAdmin) %}


                {% set othersCount = 0 %}
                {% for p in s.participants %}
                  {% if s.organisateurSortie and p.id != s.organisateurSortie.id %}
                    {% set othersCount = othersCount + 1 %}
                  {% endif %}
                {% endfor %}

                {# ... #}

                {% if app.user and canManage and etat == 'Ouverte' and etat != 'En cours' %}
                  <button
                    class="action-link btn btn-link text-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#annulerSortieModal-{{ s.id }}">
                    Annuler
              </button>


                  <div class="modal fade" id="annulerSortieModal-{{ s.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">

                        <form method="post" action="{{ path('sortie_annuler', {id: s.id}) }}">
                          <div class="modal-header">
                            <h5 class="modal-title">Annuler la sortie</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>

                          <div class="modal-body">
                            <label class="form-label">Motif d’annulation</label>
                            <textarea name="motif" class="form-control" required></textarea>
                          </div>

                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Retour</button>
                            <button type="submit" class="btn btn-danger">Confirmer</button>
                          </div>
                        </form>

                      </div>
                    </div>


                {% endif %}

              <div class="modal fade" id="annulerSortieModal-{{ s.id }}" tabindex="-1" aria-hidden="true">
                <div clasds




              </div>
              </td>

            </tr>
          {% else %}
            <tr>
              <td colspan="8" class="center">Aucune sortie trouvée.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>


         {% if app.user %}
              <div class="create-sortie" style="text-align: center">
                  <a class="btn btn-secondary" href="{{ path('sortie_create') }}" style="margin-bottom: 15px">Créer une sortie</a>
              </div>
         {% endif %}
    </section>
  </main>
{% endblock %}
